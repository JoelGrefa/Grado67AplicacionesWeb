<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Detalle de Película</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Iconos para las estrellas -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  </head>
  <body>
    <div class="container py-5">
      <div class="text-center mb-4">
        <h2 id="titulo" class="mb-3"></h2>

        <!-- Componente: Alerta informativa -->
        <div id="alerta" class="alert alert-info" role="alert" style="display: none;">
          ¡Disfruta del tráiler oficial y conoce más sobre esta película!
        </div>

        <!-- Componente: Badge de estreno o cartelera -->
        <span id="badge-estreno" class="badge bg-warning text-dark" style="display: none;"></span>
        
        <!-- Tráiler embebido -->
        <div class="ratio ratio-16x9 mb-4">
          <iframe id="trailer" src="" allowfullscreen></iframe>
        </div>
      </div>

      <!-- Tarjeta con sinopsis e imagen -->
      <div class="card mb-4">
        <div class="row g-0">
          <div class="col-md-4">
            <img
              id="poster"
              src=""
              class="img-fluid rounded-start"
              alt="Poster de la película"
            />
          </div>
          <div class="col-md-8">
            <div class="card-body">
              <h5 class="card-title">Sinopsis</h5>
              <p id="sinopsis" class="card-text"></p>

              <!-- Componente: Badge de género -->
              <span id="genero" class="badge bg-secondary"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Sección de Reseñas -->
      <div class="mt-4">
        <h3>Reseñas</h3>
        <div id="reseñas" class="list-group">
          <!-- Las reseñas se cargarán aquí mediante AJAX -->
        </div>
      </div>

      <!-- Formulario para agregar una reseña -->
      <div class="mt-4">
        <h4>Deja tu comentario</h4>
        <form id="form-comentario">
          <div class="mb-3">
            <label for="comentario" class="form-label">Comentario</label>
            <textarea class="form-control" id="comentario" rows="4" required></textarea>
          </div>
          
          <div class="mb-3">
            <label for="calificacion" class="form-label">Calificación (1-5)</label>
            <input type="number" class="form-control" id="calificacion" min="1" max="5" required />
          </div>
          
          <button type="submit" class="btn btn-primary">Enviar Comentario</button>
        </form>
      </div>

      <div class="text-center">
        <a href="../index.html" class="btn btn-secondary">Volver al inicio</a>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
      $(function () {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get("id");

        // Función para convertir cualquier enlace de YouTube a formato "embed"
        function toEmbed(u) {
          try {
            const url = new URL(u);
            const host = url.hostname;

            // youtu.be/<id>
            if (host.includes("youtu.be")) {
              const vid = url.pathname.replace("/", "");
              return `https://www.youtube.com/embed/${vid}`;
            }

            // youtube.com/watch?v=<id>
            if (host.includes("youtube.com")) {
              if (url.pathname.startsWith("/embed/")) return u;
              const v = url.searchParams.get("v");
              if (v) return `https://www.youtube.com/embed/${v}`;
            }
          } catch (e) {
            console.warn("Error al convertir URL del tráiler:", e);
          }
          return u; // fallback
        }

        $.ajax({
          url: "../data/peliculas.json",
          method: "GET",
          dataType: "json",
          success: function (peliculas) {
            const peli = peliculas.find((p) => p.id == id);
            if (peli) {
              $("#titulo").text(peli.titulo);
              $("#poster").attr("src", "../img/" + peli.imagen);
              $("#sinopsis").text(peli.sinopsis);

              // Convierte automáticamente el link del tráiler
              $("#trailer").attr("src", toEmbed(peli.trailer));

              // Muestra géneros correctamente, sea array o texto simple
              const gen = Array.isArray(peli.generos)
                ? peli.generos.join(", ")
                : peli.genero || "";
              $("#genero").text(gen);

              // Mostrar el badge de estreno o cartelera + precio
              const fechaEstreno = new Date(peli.estreno);
              const fechaActual = new Date();
              let precio = peli.precios.normal;
              let mensajeEstreno = "En Cartelera"; // Por defecto es "En Cartelera"

              // Si la película es un estreno
              if (fechaActual < fechaEstreno) {
                mensajeEstreno = "Estreno";
                precio = peli.precios.estreno;
              }

              // Mostrar el badge o alerta
              $("#badge-estreno").text(mensajeEstreno + " - Precio: $ " + precio.toFixed(2));
              $("#badge-estreno").show(); // Mostrar el badge

              // Mostrar la alerta de tráiler
              $("#alerta").text(`¡Disfruta del tráiler oficial de ${peli.titulo} y conoce más sobre esta película!`);
              $("#alerta").show();
            } else {
              mostrarError();
            }
          },
          error: function () {
            mostrarError();
          },
        });

        // Cargar las reseñas
        $.ajax({
          url: "../data/reseñas.json", // Ruta al archivo JSON de reseñas
          method: "GET",
          dataType: "json",
          success: function (reseñas) {
            const reseñasPelicula = reseñas.find(r => r.peliculaId == id);
            if (reseñasPelicula) {
              let html = "";
              reseñasPelicula.reseñas.forEach(function (reseña) {
                html += `
                  <div class="list-group-item">
                    <p><strong>Comentario:</strong> ${reseña.comentario}</p>
                    <p><strong>Calificación: </strong>${mostrarEstrellas(reseña.calificacion)}</p>
                  </div>
                `;
              });
              $("#reseñas").html(html); // Insertar las reseñas en la sección
            } else {
              $("#reseñas").html('<p>No hay reseñas para esta película.</p>');
            }
          },
          error: function () {
            $("#reseñas").html('<p>Error al cargar las reseñas.</p>');
          }
        });

        // Función para convertir la calificación a estrellas
        function mostrarEstrellas(calificacion) {
          let estrellas = "";
          for (let i = 1; i <= 5; i++) {
            if (i <= calificacion) {
              estrellas += '<i class="bi bi-star-fill text-warning"></i>'; // Estrella llena
            } else {
              estrellas += '<i class="bi bi-star text-warning"></i>'; // Estrella vacía
            }
          }
          return estrellas;
        }

        // Agregar nuevo comentario
        $("#form-comentario").on("submit", function (e) {
          e.preventDefault();
          
          const comentario = $("#comentario").val();
          const calificacion = $("#calificacion").val();

          if (comentario && calificacion >= 1 && calificacion <= 5) {
            const nuevaReseña = `
              <div class="list-group-item">
                <p><strong>Comentario:</strong> ${comentario}</p>
                <p><strong>Calificación: </strong>${mostrarEstrellas(calificacion)}</p>
              </div>
            `;
            $("#reseñas").prepend(nuevaReseña); // Añadir la nueva reseña al principio de la lista

            // Limpiar el formulario
            $("#comentario").val("");
            $("#calificacion").val("");
          } else {
            alert("Por favor, completa todos los campos correctamente.");
          }
        });

        function mostrarError() {
          $("body").html(`
            <div class="container text-center py-5">
              <div class="alert alert-danger" role="alert">
                No se pudo cargar la información de la película.
              </div>
              <a href="../index.html" class="btn btn-secondary mt-3">Volver al inicio</a>
            </div>
          `);
        }
      });
    </script>
  </body>
</html>
